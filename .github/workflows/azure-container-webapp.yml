# Azure Container Web App Deployment Workflow
#
# This workflow builds a Docker container and deploys it to Azure Container Web App.
#
# QUICK START:
# 1. Create an Azure Container Web App (Linux, Docker Container)
# 2. Download the Publish Profile from Azure Portal (Web App → Overview → Get publish profile)
# 3. Add GitHub secret: AZURE_WEBAPP_PUBLISH_PROFILE (paste publish profile contents)
# 4. Create GitHub PAT with 'read:packages' and 'write:packages' scopes
# 5. Configure Azure Web App settings (Configuration → Application settings):
#    - DOCKER_REGISTRY_SERVER_URL = https://ghcr.io
#    - DOCKER_REGISTRY_SERVER_USERNAME = Your GitHub username
#    - DOCKER_REGISTRY_SERVER_PASSWORD = Your GitHub PAT
#    - WEBSITES_PORT = 8000
#    - PORT = 8000
# 6. Update AZURE_WEBAPP_NAME below with your Azure Web App name
# 7. Enable GitHub Actions write permissions (Settings → Actions → General → Read and write permissions)
#
# For detailed instructions, see: docs/AZURE_DEPLOYMENT.md
# For a checklist, see: docs/DEPLOYMENT_CHECKLIST.md

name: Build and deploy a container to an Azure Web App

env:
  # CONFIGURATION REQUIRED: Update this with your Azure Web App name
  # Example: movie-recs-app, my-movie-system, etc.
  AZURE_WEBAPP_NAME: movie-recs-app  # TODO: Replace with your actual Azure Web App name

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    # This job builds the Docker image and pushes it to GitHub Container Registry (GHCR)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Lowercase the repo name and username
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Build and push container image to registry
        uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09 # v5.0.0
        with:
          push: true
          tags: ghcr.io/${{ env.REPO }}:${{ github.sha }}
          file: ./Dockerfile

  deploy:
    permissions:
      contents: none
    runs-on: ubuntu-latest
    needs: build
    # This job deploys the Docker image from GHCR to Azure Container Web App
    environment:
      name: 'Development'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Lowercase the repo name and username
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}  # Configured in GitHub Secrets
          images: 'ghcr.io/${{ env.REPO }}:${{ github.sha }}'
